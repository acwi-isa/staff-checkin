<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Employee ID Validator</title>
  <style>
    body { font-family: sans-serif; text-align: center; margin-top: 100px; }
    input { font-size: 24px; padding: 10px; width: 300px; }
    #result { font-size: 28px; margin-top: 20px; }
    .valid { color: green; }
    .invalid { color: red; }
  </style>
</head>
<body>
  <h2>Scan Employee ID</h2>
  <input type="text" id="scanner" autofocus />
  <div id="result"></div>

  <script>
    const scriptURL = "https://script.google.com/macros/s/AKfycbx4-X-5q4qNiQwAHtngp4Ky_R9VempVhN3pyx0g7tl3CUAHzRgtkU_zaPklJur4oW1csw/exec";
    let employeeList = [];

    const input = document.getElementById("scanner");
    const result = document.getElementById("result");

    async function fetchIDs() {
      try {
        const res = await fetch(scriptURL);
        employeeList = await res.json();
      } catch (err) {
        result.innerText = "❌ Failed to load ID list";
        console.error("Error fetching IDs:", err);
      }
    }

    fetchIDs().then(() => {
      input.focus();
    });

    async function hasRecentCheckIn(id) {
      try {
        const res = await fetch(`${scriptURL}?check=true&id=${encodeURIComponent(id)}`);
        const data = await res.json();
        return data.recent;
      } catch (err) {
        console.error("Failed to check recent scan:", err);
        return false;
      }
    }

    input.addEventListener("keydown", async function (e) {
      if (e.key === "Enter") {
        const scannedID = input.value.trim();
        input.value = "";
        input.focus();

        const match = employeeList.find(emp => emp.id === scannedID);

        if (!match) {
          result.innerHTML = "❌ Invalid ID. Please try again.";
          result.className = "invalid";
        } else {
          const recent = await hasRecentCheckIn(scannedID);

          if (recent) {
            result.innerHTML = `⚠️ ${match.name} already checked in (within 3 hours)`;
            result.className = "invalid";
          } else {
            result.innerHTML = `✅ ${match.name} checked in`;
            result.className = "valid";

            try {
              await fetch(scriptURL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ id: scannedID, valid: true })
              });
            } catch (err) {
              console.error("Failed to log scan:", err);
            }
          }
        }

        setTimeout(() => {
          result.innerHTML = "";
          result.className = "";
        }, 3000);
      }
    });
  </script>
</body>
</html>
